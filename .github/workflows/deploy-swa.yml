name: Deploy (Azure Static Web Apps)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify Entra build env (non-empty)
        env:
          VITE_ENTRA_TENANT_ID: ${{ secrets.VITE_ENTRA_TENANT_ID }}
          VITE_ENTRA_CLIENT_ID: ${{ secrets.VITE_ENTRA_CLIENT_ID }}
          VITE_ENTRA_API_SCOPE: ${{ secrets.VITE_ENTRA_API_SCOPE }}
        run: |
          set -euo pipefail
          missing=0
          if [ -z "${VITE_ENTRA_TENANT_ID:-}" ]; then echo "::error::Missing/empty GitHub secret: VITE_ENTRA_TENANT_ID"; missing=1; fi
          if [ -z "${VITE_ENTRA_CLIENT_ID:-}" ]; then echo "::error::Missing/empty GitHub secret: VITE_ENTRA_CLIENT_ID"; missing=1; fi
          if [ -z "${VITE_ENTRA_API_SCOPE:-}" ]; then echo "::error::Missing/empty GitHub secret: VITE_ENTRA_API_SCOPE"; missing=1; fi
          if [ "$missing" -ne 0 ]; then exit 1; fi

      - name: Build frontend (Vite)
        env:
          VITE_API_BASE_URL: /api
          VITE_AUTH_MODE: entra
          VITE_ENTRA_TENANT_ID: ${{ secrets.VITE_ENTRA_TENANT_ID }}
          VITE_ENTRA_CLIENT_ID: ${{ secrets.VITE_ENTRA_CLIENT_ID }}
          VITE_ENTRA_API_SCOPE: ${{ secrets.VITE_ENTRA_API_SCOPE }}
        run: npm run build

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: .
          api_location: api
          output_location: dist
